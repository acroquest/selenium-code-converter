---
# ----------------------------------------------------------------------------
# Copyright (c) Acroquest Technology Co, Ltd. All Rights Reserved.
# Please read the associated COPYRIGHTS file for more details.
# 
# THE SOFTWARE IS PROVIDED BY Acroquest Technology Co., Ltd.,
# WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING
# BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
# IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDER BE LIABLE FOR ANY
# CLAIM, DAMAGES SUFFERED BY LICENSEE AS A RESULT OF USING, MODIFYING
# OR DISTRIBUTING THIS SOFTWARE OR ITS DERIVATIVES.
# ----------------------------------------------------------------------------
#
#========================================================
# Selenium Code Converter 変換設定ファイル
# version: 0.5.0
# memo:
# * 「after : |2」の指定は、置換先が複数行でインデントが 2 であることを意味します。詳細はyaml仕様を参照ください。
#
#========================================================
#
#------------------------------------------------------------------------------
# Import 定義の追加
#------------------------------------------------------------------------------
- before : '\npublic class ([a-zA-Z0-9]+) \{'
  after : |2
    
    import java.io.File;
    import java.io.IOException;
    import java.nio.file.Files;
    import java.nio.file.Path;
    import java.nio.file.Paths;
    import org.apache.commons.io.FilenameUtils;
    import org.openqa.selenium.edge.EdgeDriver;
    import org.openqa.selenium.ie.InternetExplorerDriver;
    import org.openqa.selenium.chrome.ChromeDriver;
    import org.openqa.selenium.safari.SafariDriver;
    import org.openqa.selenium.remote.DesiredCapabilities;
    import org.openqa.selenium.remote.RemoteWebDriver;
    import org.openqa.selenium.remote.Augmenter;

    public class $1 {
    
      /** テスト対象のブラウザ */ 
      private String browser;
      /** 画面キャプチャファイルの保存ディレクトリ */ 
      private String captureDirectory;
      /** 画面キャプチャファイル名にクラス名を追加 */ 
      private boolean addClassNameToCaptureFile = false;
      /** 画面キャプチャファイル名に連番を追加 */ 
      private boolean addSeqNoToCaptureFile = false;
      /** 画像キャプチャファイルの連番 */ 
      private int captureSeqNo = 0;
      /** 画面キャプチャファイル名末尾にブラウザ名を追加 */ 
      private boolean captureFileWithBrowserName = false;
      
#------------------------------------------------------------------------------
# ドライバ定義の追加
#------------------------------------------------------------------------------
- before : '\n([^\S\x0a\x0d]*)driver = new FirefoxDriver\(\);'
  after : |2
    
    $1//SCC: 以下をコメントイン/コメントアウトしてブラウザを指定します。
    $1//browser = "ie";
    $1browser = "edge";
    $1//browser = "firefox";
    $1//browser = "edge";
    $1//browser = "chrome";
    $1//browser = "safari-mac";
    $1//browser = "chrome-mac";
    $1//browser = "firefox-mac";
    
    $1//browser = "ie64";
    $1//browser = "firefox64";
    
    $1// SCC: propertyでのブラウザ指定があればそちらを優先します。
    $1String propBrowser = System.getProperty("browser");
    $1if (propBrowser != null){
    $1  browser = propBrowser;
    $1}
    
    $1captureDirectory = System.getProperty("capturedirectory");    // SCC: 画面キャプチャファイルの保存場所のプロパティ指定を取得。
    $1if (captureDirectory == null){    // SCC: 指定がない場合はプロジェクトルートに保存します。
    $1  captureDirectory = ".";
    $1}

    $1addClassNameToCaptureFile = true;    // SCC: 画面キャプチャファイル名にクラス名を追加。
    $1String propClassname2capfile = System.getProperty("classname2capfile");    // SCC: プロパティ指定があればそちらを優先します。
    $1if (propClassname2capfile != null){
    $1  addClassNameToCaptureFile = Boolean.parseBoolean(propClassname2capfile);
    $1}
    
    $1addSeqNoToCaptureFile = true;    // SCC: 画面キャプチャファイル名に連番を追加。
    $1String propSeqno2capfile = System.getProperty("seqno2capfile");    // SCC: プロパティ指定があればそちらを優先します。
    $1if (propSeqno2capfile != null){
    $1  addSeqNoToCaptureFile = Boolean.parseBoolean(propSeqno2capfile);
    $1}
    
    $1captureFileWithBrowserName = false;    // SCC: 画面キャプチャファイル名の末尾にブラウザ名を追加しない。
    $1String propBrowsername2capfile = System.getProperty("browsername2capfile");    // SCC: プロパティ指定があればそちらを優先します。
    $1if (propBrowsername2capfile != null){
    $1  captureFileWithBrowserName = Boolean.parseBoolean(propBrowsername2capfile);
    $1}
    
    $1driver = createWebDriver(browser);    // SCC: WebDriver を作成します。
    
#------------------------------------------------------------------------------
# ドライバ設定
#------------------------------------------------------------------------------
- before : '\n([^\S\x0a\x0d]*)(driver.manage\(\)\.timeouts\(\)\.implicitlyWait\(30, TimeUnit\.SECONDS\);)'
  after : |2
    
    $1$2
    $1driver.manage().window().setPosition(new Point(0,0));
    $1driver.manage().window().setSize(new Dimension(1280,800));    // SCC: ブラウザサイズ設定。
    $1//driver.manage().window().maximize();    // SCC: ブラウザを最大化する場合。
#------------------------------------------------------------------------------
# 未対応コマンド : selectFrame relative=top
#------------------------------------------------------------------------------
- before : '\n([^\S\x0a\x0d]*)// ERROR: Caught exception \[ERROR: Unsupported command \[selectFrame \| relative=top \| \]\]'
  after : |2
    
    $1driver.switchTo().defaultContent();    // SCC: Frameトップに戻る。
#------------------------------------------------------------------------------
# 未対応コマンド : selectFrame index=
#------------------------------------------------------------------------------
- before : '\n([^\S\x0a\x0d]*)// ERROR: Caught exception \[ERROR: Unsupported command \[selectFrame \| index=(\d+) \| \]\]'
  after : |2
    
    $1driver.switchTo().defaultContent();    // SCC: Experimental. Frameトップに戻ってから、次レベル フレームへの移動を想定。
    $1driver.switchTo().frame($2);    // SCC: フレームネストが深い場合は要調整。
#------------------------------------------------------------------------------
# 未対応コマンド : selectFrame
#------------------------------------------------------------------------------
- before : '\n([^\S\x0a\x0d]*)// ERROR: Caught exception \[ERROR: Unsupported command \[selectFrame \| ([^=]+?) \| \]\]'
  after : |2
    
    $1driver.switchTo().defaultContent();    // SCC: Experimental. Frameトップに戻ってから、次レベル フレームへの移動を想定。
    $1driver.switchTo().frame("$2");    // SCC: フレームネストが深い場合は要調整。
#------------------------------------------------------------------------------
# 未対応コマンド : selectWindow
#------------------------------------------------------------------------------
- before : '\n([^\S\x0a\x0d]*)// ERROR: Caught exception \[ERROR: Unsupported command \[selectWindow \| name=(.+?) \| \]\]'
  after : |2
    
    $1try{
    $1  driver.switchTo().window("$2");
    $1}catch(NoSuchWindowException e){    // SCC: 指定名のウィンドウがない場合はフレームと仮定。
    $1  driver.switchTo().defaultContent();    // SCC: Experimental. Frame操作時にSelenium IDEにてselectWindowとして記録された。
    $1  driver.switchTo().frame("$2");    // SCC: フレームネストが深い場合は要調整。
    $1}
#------------------------------------------------------------------------------
# 未対応コマンド : selectWindow null
#------------------------------------------------------------------------------
- before : '\n([^\S\x0a\x0d]*)// ERROR: Caught exception \[ERROR: Unsupported command \[selectWindow \| null \| \]\]'
  after : |2
    
    $1driver.switchTo().window(driver.getWindowHandles().toArray()[0].toString());    // SCC: Experimental. [0]は必要に応じて調整。
#------------------------------------------------------------------------------
# 未対応コマンド : openWindow ${変数}
#------------------------------------------------------------------------------
- before : '\n([^\S\x0a\x0d]*)// ERROR: Caught exception \[ERROR: Unsupported command \[openWindow \| \$\{(.+?)\} \| (.+?)\]\]'
  after : |2
    
    $1((JavascriptExecutor) driver).executeScript("window.open('" + $2 + "','$3')");    // SCC: Experimental.
#------------------------------------------------------------------------------
# 未対応コマンド : openWindow http~
#------------------------------------------------------------------------------
- before : '\n([^\S\x0a\x0d]*)// ERROR: Caught exception \[ERROR: Unsupported command \[openWindow \| (http.+?) \| (.+?)\]\]'
  after : |2
    
    $1((JavascriptExecutor) driver).executeScript("window.open('$2','$3')");    // SCC: Experimental.
#------------------------------------------------------------------------------
# 未対応コマンド : openWindow
#------------------------------------------------------------------------------
- before : '\n([^\S\x0a\x0d]*)// ERROR: Caught exception \[ERROR: Unsupported command \[openWindow \| (.+?) \| (.+?)\]\]'
  after : |2
    
    $1((JavascriptExecutor) driver).executeScript("window.open('" + baseUrl + "$2" + "','$3')");    // SCC: Experimental.
#------------------------------------------------------------------------------
# 未対応コマンド : キャプチャ
#------------------------------------------------------------------------------
- before : '\n([^\S\x0a\x0d]*)// ERROR: Caught exception \[ERROR: Unsupported command \[captureEntirePageScreenshot \| [a-zA-Z]:[^\x0a\x0d]*[\\/]([a-zA-Z0-9_-].*\.(png|jpg)).*\]'
  after : |2
    
    $1{
    $1  capture("$2");
    $1}
#------------------------------------------------------------------------------
# 未対応コマンド : Dom locators
#   Selenium IDE Options > フォーマット > Java/JUnit4/WebDriverにて Show Selenese オンでエクスポートした場合
#------------------------------------------------------------------------------
- before : '\n([^\S\x0a\x0d]*)(// click \| (.+?) \| )\n[^\S\x0a\x0d]*// ERROR: Caught exception \[Error: Dom locators are not implemented yet\!\]'
  after : |2
    
    $1$2
    $1Thread.sleep(100);    // SCC: 安定化調整
    $1click(((WebElement) ((JavascriptExecutor) driver).executeScript("return $3;")));
#    $1Thread.sleep(100);    // SCC: 安定化調整
#    $1((WebElement) ((JavascriptExecutor) driver).executeScript("return $3;")).sendKeys(Keys.CONTROL);    // SCC: Experimental. 安定化調整
#    $1Thread.sleep(500);    // SCC: 安定化調整
#    $1((WebElement) ((JavascriptExecutor) driver).executeScript("return $3;")).click();    // SCC: Experimental. 
#------------------------------------------------------------------------------
# 未対応コマンド : StoreEval ページサイズ変更用 javascript コマンドへの特別対応
#------------------------------------------------------------------------------
- before : '\n([^\S\x0a\x0d]*)// ERROR: Caught exception \[ERROR: Unsupported command \[getEval \| javascript\{window\.opener\.resizeTo\((\d+),(\d+)\)\} \| \]\]'
  after : |2
    
    $1driver.manage().window().setSize(new Dimension($2,$3));    // SCC: ページサイズ変更用 javascript コマンドから置換。

#------------------------------------------------------------------------------
# 未対応コマンド : StoreEval 暫定コメントアウト対応
#------------------------------------------------------------------------------
- before : '\n([^\S\x0a\x0d]*)// ERROR: Caught exception \[ERROR: Unsupported command \[getEval \| //\\-(.+?) \| \]\]'
  after : |2
    
    $1((JavascriptExecutor) driver).executeScript("$2");    // IDE 上での js 定義にて暫定コメントアウト文字列「//\\-」を検出したので、コメントアウトを解除しました。
#------------------------------------------------------------------------------
# 未対応コマンド : StoreEval
#------------------------------------------------------------------------------
- before : '\n([^\S\x0a\x0d]*)// ERROR: Caught exception \[ERROR: Unsupported command \[getEval \| (.+?) \| \]\]'
  after : |2
    
    $1((JavascriptExecutor) driver).executeScript("$2");
#------------------------------------------------------------------------------
# 安定化調整 : click
#------------------------------------------------------------------------------
- before : '\n([^\S\x0a\x0d]*)(driver.findElement\((.+?)\)).click\(\);'
  after : |2
    
    $1clickElement($3);
#--- 要素毎に微調整が必要な場合は、上記をコメント化して以下を使用してください。
#    $1$2.sendKeys(Keys.CONTROL);    // SCC: 安定化調整
#    $1Thread.sleep(500);    // SCC: 安定化調整
#    $1$2.click();
#------------------------------------------------------------------------------
# 安定化調整 : driver.get
#------------------------------------------------------------------------------
- before : '\n([^\S\x0a\x0d]*)(driver.get\(baseUrl \+ ".*?"\);)'
  after : |2
    
    $1$2
    $1driver.manage().timeouts().implicitlyWait(30, TimeUnit.SECONDS);    // SCC: 安定化調整
#------------------------------------------------------------------------------
# ブラウザ終了
#------------------------------------------------------------------------------
- before : '\n([^\S\x0a\x0d]*)driver.quit\(\);'
  after : |2
    
    $1driver.quit\(\);
#------------------------------------------------------------------------------
# ヘルパー関数定義の追加
#------------------------------------------------------------------------------
- before : '(}\s$)'
  after : |2
 
      /**
       * 画面要素をクリックする。
       *
       * @param element 画面要素
       */
      public void click(WebElement element) throws Exception
      {
        element.sendKeys(Keys.CONTROL);    // SCC: 安定化調整
        Thread.sleep(500);    // SCC: 安定化調整
        element.click();
      }

      /**
       * 画面要素を見つけてクリックする。
       *
       * @param locator 要素ロケータ
       */
      public void clickElement(By locator) throws Exception
      {
        click(driver.findElement(locator));
      }

      /**
       * 画面キャプチャを指定ファイル名で保存する。
       *
       * @param fileName 保存ファイル名
       */
      public void capture(String fileName) throws Exception
      {
        String newFileName =  fileName;
        if(captureFileWithBrowserName == true){    // SCC: ブラウザ名を追加します。
          Capabilities cap = ((RemoteWebDriver) driver).getCapabilities();
          String browserName = cap.getBrowserName().toLowerCase();
          newFileName = FilenameUtils.removeExtension(fileName) + '_' + browserName + '.' + FilenameUtils.getExtension(fileName);
        }
        if(addSeqNoToCaptureFile == true){    // SCC: 連番を追加します。
          captureSeqNo += 1;
          newFileName = String.format("%03d", captureSeqNo) + '_' + newFileName;
        }
        if(addClassNameToCaptureFile == true){    // SCC: クラス名を追加します。
          String classNm = this.getClass().getSimpleName();
          newFileName = classNm + '_' + newFileName;
        }
        capture(driver, Paths.get(captureDirectory), newFileName);
      }

      public static void capture(WebDriver driver, Path captureDirectory,
              String fileName) throws Exception
      {

          WebDriver tempdriver = driver;
          if (!(driver instanceof TakesScreenshot))
          {
              tempdriver = new Augmenter().augment(driver);
          }
          Thread.sleep(1000);
          TakesScreenshot screen = (TakesScreenshot) tempdriver;
          Path capture = captureDirectory.resolve(fileName);
          try
          {
              Files.write(capture, screen.getScreenshotAs(OutputType.BYTES));
          }
          catch (IOException e)
          {
              e.printStackTrace();
          }
      }
  
      /**
       * 引数に指定された webdriver を作成する。
       *
       * @param browserName ブラウザ名
       * @return WebDriverオブジェクト
       */
      public static WebDriver createWebDriver(String browserName){
        WebDriver driver = null;
        switch (browserName.trim().toLowerCase())
        {
            case "safari-mac":
              driver = new SafariDriver();
              break;

            case "chrome":
              System.setProperty("webdriver.chrome.driver",new File(".").getAbsoluteFile().getParent()
                  + "\\\\lib\\\\chromedriver.exe");
              driver = new ChromeDriver();
              break;

            case "chrome-mac":
              System.setProperty("webdriver.chrome.driver",new File(".").getAbsoluteFile().getParent()
                  + "/lib/chromedriver_mac64");
              driver = new ChromeDriver();
              break;

            case "ie":
              System.setProperty("webdriver.ie.driver",
                new File(".").getAbsoluteFile().getParent()
                  + "\\\\lib\\\\IEDriverServer.exe");
                driver = new InternetExplorerDriver();
              break;

            case "ie64":
              System.setProperty("webdriver.ie.driver",
                new File(".").getAbsoluteFile().getParent()
                  + "\\\\lib\\\\IEDriverServer64.exe");
                driver = new InternetExplorerDriver();
              break;

            case "firefox":
              System.setProperty("webdriver.gecko.driver",new File(".").getAbsoluteFile().getParent()
                  + "\\\\lib\\\\geckodriver.exe");
                driver = new FirefoxDriver();
              break;

            case "firefox-mac":
              System.setProperty("webdriver.gecko.driver",new File(".").getAbsoluteFile().getParent()
                  + "/lib/geckodriver_macos");
                driver = new FirefoxDriver();
              break;

            case "firefox64":
              System.setProperty("webdriver.gecko.driver",new File(".").getAbsoluteFile().getParent()
                  + "\\\\lib\\\\geckodriver64.exe");
                driver = new FirefoxDriver();
              break;

            case "edge":
              System.setProperty("webdriver.edge.driver",
                      new File(".").getAbsoluteFile().getParent()
                              + "\\\\lib\\\\MicrosoftWebDriver.exe");
              driver = new EdgeDriver();
              break;

            default:
              break;
        }
        return driver;
      }
    $1
